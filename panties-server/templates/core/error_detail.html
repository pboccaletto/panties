{% extends "base.html" %}
{% load static %}
{% block title %}Error #{{ error.id }} - {{ project.name }} - Panties{% endblock %}

{% block content %}
<nav class="breadcrumb" aria-label="breadcrumbs">
  <ul>
    <li><a href="{% url 'core:project_list' %}">
      <i class="fas fa-folder mr-1"></i>Projects
    </a></li>
    <li><a href="{% url 'core:project_detail' project.pk %}">{{ project.name }}</a></li>
    <li class="is-active"><a href="#" aria-current="page">Error #{{ error.id }}</a></li>
  </ul>
</nav>

<div class="level mb-5">
  <div class="level-left">
    <div class="level-item">
      <div>
        <h1 class="title is-2">
          <span style="font-size: 2rem;">üêõ</span>
          <span class="ml-2">Error #{{ error.id }}</span>
        </h1>
        <div class="subtitle is-5">
          <span class="error-type-badge error-type-{{ error.event_type }} mr-2">
            {% if error.event_type == 'exception' %}
              <i class="fas fa-bug mr-1"></i>
            {% else %}
              <i class="fas fa-envelope mr-1"></i>
            {% endif %}
            {{ error.event_type }}
          </span>
          {% if error.level %}
            <span class="level-badge level-{{ error.level }} mr-2">
              <i class="fas fa-signal mr-1"></i>
              {{ error.level }}
            </span>
          {% endif %}
          {% if error.exception_type %}
            <span class="tag is-danger is-medium">{{ error.exception_type }}</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="level-right">
    <div class="level-item">
      {% if can_edit %}
        <a class="button is-danger" href="{% url 'core:error_delete' project.pk error.pk %}">
          <span class="icon"><i class="fas fa-trash"></i></span>
          <span>Delete</span>
        </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Message Section -->
{% if error.message %}
<div class="box mb-5">
  <h2 class="title is-4">
    <i class="fas fa-comment-alt mr-2"></i>
    Error Message
  </h2>
  <div class="notification is-danger is-light">
    <p class="is-size-5 has-text-weight-semibold">{{ error.message }}</p>
  </div>
</div>
{% endif %}

<!-- Stack Trace - Main Focus -->
<div class="box mb-5">
  <div class="level mb-4">
    <div class="level-left">
      <div class="level-item">
        <h2 class="title is-3">
          <span style="font-size: 2rem;">üìö</span>
          <span class="ml-2">Stack Trace</span>
        </h2>
      </div>
    </div>
    <div class="level-right">
      <div class="level-item">
        <button class="button is-light" onclick="copyStacktrace()">
          <span class="icon">
            <i class="fas fa-copy"></i>
          </span>
          <span>Copy</span>
        </button>
      </div>
    </div>
  </div>

  {% if error.stacktrace %}
    <div class="stacktrace-container" id="stacktraceContent">
      <pre>{{ error.stacktrace }}</pre>
    </div>
  {% else %}
    <div class="notification is-warning is-light">
      <p class="is-size-5">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        No stack trace available for this error.
      </p>
    </div>
  {% endif %}
</div>

<!-- Metadata in Columns -->
<div class="columns">
  <!-- Left Column -->
  <div class="column is-6">
    <!-- Overview Box -->
    <div class="box mb-4">
      <h2 class="title is-5">
        <i class="fas fa-info-circle mr-2"></i>
        Overview
      </h2>
      <div class="content">
        <table class="table is-fullwidth">
          <tbody>
            <tr>
              <th style="width: 40%;">
                <i class="fas fa-fingerprint mr-2"></i>
                Event ID
              </th>
              <td>
                {% if error.event_id %}
                  <code>{{ error.event_id }}</code>
                {% else %}
                  <span class="has-text-grey">-</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>
                <i class="fas fa-tag mr-2"></i>
                Event Type
              </th>
              <td>
                <span class="error-type-badge error-type-{{ error.event_type }}">
                  {{ error.event_type }}
                </span>
              </td>
            </tr>
            {% if error.level %}
            <tr>
              <th>
                <i class="fas fa-signal mr-2"></i>
                Level
              </th>
              <td>
                <span class="level-badge level-{{ error.level }}">{{ error.level }}</span>
              </td>
            </tr>
            {% endif %}
            {% if error.exception_type %}
            <tr>
              <th>
                <i class="fas fa-exclamation-circle mr-2"></i>
                Exception Type
              </th>
              <td>
                <span class="tag is-danger is-light">{{ error.exception_type }}</span>
              </td>
            </tr>
            {% endif %}
            <tr>
              <th>
                <i class="fas fa-clock mr-2"></i>
                Timestamp
              </th>
              <td>{{ error.timestamp|date:"Y-m-d H:i:s" }}</td>
            </tr>
            {% if error.environment %}
            <tr>
              <th>
                <i class="fas fa-cogs mr-2"></i>
                Environment
              </th>
              <td>
                <span class="tag is-info">{{ error.environment }}</span>
              </td>
            </tr>
            {% endif %}
            {% if error.service_name %}
            <tr>
              <th>
                <i class="fas fa-server mr-2"></i>
                Service
              </th>
              <td>
                <span class="tag is-info">{{ error.service_name }}</span>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tags Box -->
    <div class="box mb-4">
      <h2 class="title is-5">
        <i class="fas fa-tags mr-2"></i>
        Tags
      </h2>
      {% if error.tags %}
        <div class="tags">
          {% for key, value in error.tags.items %}
            <span class="tag is-medium is-info is-light">
              <strong>{{ key }}:</strong>&nbsp;{{ value }}
            </span>
          {% endfor %}
        </div>
      {% else %}
        <p class="has-text-grey-light">
          <i class="fas fa-minus-circle mr-2"></i>
          No tags attached to this error.
        </p>
      {% endif %}
    </div>
  </div>

  <!-- Right Column -->
  <div class="column is-6">
    <!-- Extra Data Box -->
    <div class="box mb-4">
      <h2 class="title is-5">
        <i class="fas fa-database mr-2"></i>
        Extra Data
      </h2>
      {% if error.extra %}
        <div class="code-block">
          <pre>{{ error.extra|pprint }}</pre>
        </div>
      {% else %}
        <p class="has-text-grey-light">
          <i class="fas fa-minus-circle mr-2"></i>
          No extra data available.
        </p>
      {% endif %}
    </div>

    <!-- Context Info Box -->
    <div class="box mb-4">
      <h2 class="title is-5">
        <i class="fas fa-info-circle mr-2"></i>
        Context Information
      </h2>
      <table class="table is-fullwidth is-narrow">
        <tbody>
          <tr>
            <th style="width: 40%;">
              <i class="fas fa-folder mr-2"></i>
              Project
            </th>
            <td>
              <a href="{% url 'core:project_detail' project.pk %}">{{ project.name }}</a>
            </td>
          </tr>
          <tr>
            <th>
              <i class="fas fa-hashtag mr-2"></i>
              Error ID
            </th>
            <td><strong>#{{ error.id }}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="buttons">
  <a class="button is-panties" href="{% url 'core:error_list' project.pk %}">
    <span class="icon"><i class="fas fa-arrow-left"></i></span>
    <span>Back to All Errors</span>
  </a>
  <a class="button is-info" href="{% url 'core:project_detail' project.pk %}">
    <span class="icon"><i class="fas fa-folder"></i></span>
    <span>Back to Project</span>
  </a>
</div>

<script>
  function copyStacktrace() {
    const stacktrace = document.getElementById('stacktraceContent');
    if (stacktrace) {
      const text = stacktrace.innerText;
      navigator.clipboard.writeText(text).then(() => {
        // Visual feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<span class="icon"><i class="fas fa-check"></i></span><span>Copied!</span>';
        btn.classList.add('is-success');

        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.classList.remove('is-success');
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }
  }
</script>
{% endblock %}
